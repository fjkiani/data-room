
# Forge Page Doctrine

This doctrine guides building an interactive, demoâ€‘driven Forge page by reusing Oracle primitives and adding Forgeâ€‘specific useâ€‘cases. It focuses on generative design (guides, repair templates, proteins) with discriminative checks, all presented stepâ€‘byâ€‘step with explainable outputs and an agentic â€œDesign Brief.â€

## Objectives
- Make Forge a handsâ€‘on â€œDesign Studioâ€ for CRISPR and sequence design.
- Reuse Oracleâ€™s demo primitives; avoid restyling unless for cohesion and accessibility.
- Present flows stepâ€‘byâ€‘step (no single dump), with evidence, provenance, and agentic next steps.

## Reusable Components (from Oracle)
- Accessibility & theming: [AccessibilityToggle.tsx](mdc:src/components/AccessibilityToggle.tsx), [AccessibilityContext.tsx](mdc:src/contexts/AccessibilityContext.tsx)
- Demo primitives: [DemoFactory.tsx](mdc:src/components/site/blocks/DemoFactory.tsx)
- Step runner: [InteractiveAnalysisPipeline.tsx](mdc:src/components/site/blocks/InteractiveAnalysisPipeline.tsx)
- Dossier summary: [EnhancedDossierSummary.tsx](mdc:src/components/site/blocks/EnhancedDossierSummary.tsx)
- Data & orchestration: [dossierSummaries.ts](mdc:src/data/dossierSummaries.ts), [simulations.ts](mdc:src/utils/simulations.ts), [runUseCase.ts](mdc:src/utils/runUseCase.ts)
- Forge detail panes (optional beneath pipeline): [CandidateTable.tsx](mdc:src/components/site/forge/CandidateTable.tsx), [ConstraintPanel.tsx](mdc:src/components/site/forge/ConstraintPanel.tsx), [ObjectiveList.tsx](mdc:src/components/site/forge/ObjectiveList.tsx), [TrajectoryGraph.tsx](mdc:src/components/site/forge/TrajectoryGraph.tsx)

## Endpoints to Showcase
- Generative (primary): `/generate_optimized_guide_rna`, `/generate_repair_template`, `/generate_therapeutic_protein_coding_sequence`
'/generate_epigenome_optimized_sequence,' '/generate_therapeutic_protein_coding_sequence"
- Discriminative (support): `/predict_crispr_spacer_efficacy`, `/predict_chromatin_accessibility`, `/predict_variant_impact`, optional `/predict_immunogenicity`

See platform plan in [endpoints.md](mdc:.cursor/rules/endpoints.md).

## Page Layout (Forge)
- Header: title, mission statement, [AccessibilityToggle.tsx](mdc:src/components/AccessibilityToggle.tsx)
- Capability Grid: 3â€“5 Forge tiles with â€œRun Demoâ€ CTAs (mirror Oracleâ€™s `VisualCapabilityGrid` pattern)
- Forge Demo Factory: Cards for core generative demos with â€œğŸš€ Run Live Demoâ€
- Interactive Pipeline: [InteractiveAnalysisPipeline.tsx](mdc:src/components/site/blocks/InteractiveAnalysisPipeline.tsx) updates per step; click to inspect
- Design Brief: [EnhancedDossierSummary.tsx](mdc:src/components/site/blocks/EnhancedDossierSummary.tsx) tailored to design outputs
- Detail Panes (optional): Forge blocks under pipeline for candidates, constraints, objectives, trajectory

## Demo Flows (Stepâ€‘byâ€‘Step)
- Guide RNA Design (Knockout)
  1) Generate candidates â†’ 2) Score onâ€‘target efficacy â†’ 3) Check target accessibility â†’ 4) Offâ€‘target safety snapshot â†’ 5) Rank + export.
- HDR Repair Template Design (Correction)
  1) Build homology context â†’ 2) Generate templates with constraints â†’ 3) Likelihood/QC optimization â†’ 4) Validate â†’ 5) Export.
- Therapeutic Protein Design (Binder/Enzyme)
  1) Generate candidates â†’ 2) Function + structure scoring â†’ 3) Immunogenicity scan (optional) â†’ 4) Rank + export.

All flows must: (a) run in the step runner, (b) show evidence/provenance, (c) produce a Design Brief.

## Forge Useâ€‘Cases
Define in [forge.ts](mdc:src/data/useCases/forge.ts); expose via `/site/demo/usecase/{id}`.
- `knockout_brca1`: design highâ€‘efficacy, low offâ€‘target guides for BRCA1
- `repair_brca1_correction`: design HDR template to restore WT
- `design_pd_l1_binder`: generate a nanobody candidate for PDâ€‘L1

Use [runUseCase.ts](mdc:src/utils/runUseCase.ts) to orchestrate; simulate via [simulations.ts](mdc:src/utils/simulations.ts).

## Design Brief (Dossier)
- Reuse [EnhancedDossierSummary.tsx](mdc:src/components/site/blocks/EnhancedDossierSummary.tsx); copy in [dossierSummaries.ts](mdc:src/data/dossierSummaries.ts)
- Agentic actions:
  - Analyze offâ€‘targets â†’ run discriminative checks on selected guides
  - Ensure accessibility â†’ run chromatin check on locus
  - Regenerate with constraints â†’ open constraints panel and reâ€‘run
  - Export assets â†’ FASTA/CSV/JSON for guides/templates/proteins

## Theming & Accessibility
- Respect [AccessibilityContext.tsx](mdc:src/contexts/AccessibilityContext.tsx) `themeMode` and text sizing across all Forge UI
- No color hardâ€‘coding; rely on CSS variables + Tailwind with theme overrides (white mode default)

## DRY & Dataâ€‘Driven
- Declarative content:
  - Useâ€‘cases â†’ [forge.ts](mdc:src/data/useCases/forge.ts)
  - Simulations â†’ [simulations.ts](mdc:src/utils/simulations.ts)
  - Dossier mapping â†’ [dossierSummaries.ts](mdc:src/data/dossierSummaries.ts)
- Reuse `DemoFactory` patterns to minimize bespoke logic

## Integration Steps
1) Update [ProductForge.tsx](mdc:src/pages/ProductForge.tsx): Capability Grid, Forge Demo Factory, Pipeline, Design Brief
2) Create [forge.ts](mdc:src/data/useCases/forge.ts) with 3 useâ€‘cases; add links from capability grid and factory
3) Ensure demo CTAs call into the step runner and autoâ€‘scroll to pipeline
4) Populate dossier data for generative endpoints in [dossierSummaries.ts](mdc:src/data/dossierSummaries.ts)
5) Use [simulations.ts](mdc:src/utils/simulations.ts) to provide perâ€‘step meta: `processingSteps`, `insights`, `evidence`, `provenance`

## Validator Integration Plan (Discriminative across flows)
- Guide RNA Design
  - Onâ€‘target: `/predict_crispr_spacer_efficacy` after generation for each candidate
  - Accessibility: `/predict_chromatin_accessibility` on target locus (contextâ€‘specific)
  - Offâ€‘target proxy: `/predict_variant_impact` on top N offâ€‘target sites (snapshot, not exhaustive)
  - Optional: `/exon_intron_map` to ensure coding disruption intent (KO)
- HDR Repair Template Design
  - Correction validation: `/predict_variant_impact` on pre/post edit (delta toward WT)
  - Accessibility at insertion: `/predict_chromatin_accessibility` around locus
  - Target biology: `/predict_gene_essentiality` to support prioritization
- Therapeutic Protein Design
  - Function proxy: `/predict_protein_functionality_change` on designed protein vs reference
  - Safety: `/predict_immunogenicity` for epitope/MHC hotspot scan
  - Context: `/predict_chromatin_accessibility` only when paired with regulatory elements or expression context
- Regulatory/Epigenome Design (future)
  - Accessibility target: `/predict_chromatin_accessibility` against desired tissue/context
  - Motif sanity: optional splice/motif checks as available

Notes
- Validators run as pipeline steps with their own evidence/provenance
- Composite scores shown in UI with perâ€‘criterion breakdown (efficacy, accessibility, safety)

## Orchestrators Plan
- Diagnostics aggregator: `analyze_cancer_hallmarks` (aka `get_hallmark_profile`)
  - Use: preâ€‘design framing or postâ€‘validation summary of vulnerabilities guiding design choices
  - Output: hallmark scores, prioritized vulnerabilities shown as context panel and fed into Design Brief
- Therapy strategy: `design_personalized_therapy` (aka `get_personalized_strategy`)
  - Use: endâ€‘ofâ€‘demo synthesis that selects targets and bundles generated assets (guides/templates) with rationale
  - Output: target, modality, asset list; surfaces as top of the Design Brief with agentic next steps

## Hybrid Endâ€‘toâ€‘End Demo Plan
- Execution modes
  - Simulated (default): fast, deterministic demos using [simulations.ts](mdc:src/utils/simulations.ts)
  - Live (later): swap in adapters per endpoint via [runUseCase.ts](mdc:src/utils/runUseCase.ts) `adapters` map
- Orchestration
  - Useâ€‘case defined in data (`forge.ts`) â†’ step runner executes generative â†’ validators â†’ orchestrator
  - Each step updates [InteractiveAnalysisPipeline.tsx](mdc:src/components/site/blocks/InteractiveAnalysisPipeline.tsx) incrementally
- Artifacts & provenance
  - Persist demo artifacts (FASTA/CSV/JSON) and display evidence/provenance per step
  - Design Brief summarizes assets and statuses; agentic buttons trigger followâ€‘ups (validators or regeneration)
- Extensibility
  - Add constraints & reâ€‘run: integrate [ConstraintPanel.tsx](mdc:src/components/site/forge/ConstraintPanel.tsx) to update inputs and rerun selectively
  - Toggle simulated/live per step with a `runMode` flag in useâ€‘case steps

## Testing
- Visual: White mode default; high contrast text; dark borders in white mode
- Functional: Steps update incrementally; clicking completed steps opens detail modal
- Export: Download artifacts postâ€‘run (FASTA/CSV/JSON)

## Nonâ€‘Goals
- Do not purge existing Forge styles unless needed for cohesion/accessibility
- Avoid bespoke oneâ€‘offs when an Oracle primitive fits

## Flow Patterns (Applied Across Demos)
- Guide RNA design
  - Generate candidates â†’ Efficacy check â†’ Accessibility check â†’ Offâ€‘target proxy snapshot â†’ Rank â†’ Export assets
- HDR repair template design
  - Generate templates â†’ Likelihood/QC optimization â†’ Variant correction validation â†’ Accessibility check â†’ Export assets
- Therapeutic protein design
  - Generate candidates â†’ Function + Structure proxy â†’ Immunogenicity scan â†’ Rank â†’ Export assets

## Metrics & Ranking Surfaced Per Step
- Guides: on_target efficacy, accessibility, off_target_proxy; composite score and rank
- HDR templates: sequence likelihood, GC/repeats QC, correction delta toward WT
- Proteins: function_score (proxy), structure_score (proxy), immunogenicity_risk

## UI Reuse Plan
- Demo launch: Forgeâ€‘scoped DemoFactory cards with â€œğŸš€ Run Live Demoâ€
- Step execution: InteractiveAnalysisPipeline with incremental updates and clickâ€‘toâ€‘inspect
- Summary: EnhancedDossierSummary as â€œDesign Briefâ€ with agentic actions (offâ€‘target scan, accessibility check, regenerate with constraints, export)
- Refine loops: ConstraintPanel + CandidateTable beneath pipeline to tweak inputs and reâ€‘run selected steps

## Hybrid Execution Modes (Details)
- Default simulated: use simulations.ts to provide output, processingSteps, insights, evidence, provenance for fast demos
- Live adapters later: supply adapters map to runUseCase; set perâ€‘step runMode to 'live' to mix simulated + live in one pipeline
- Provenance: label each step (evo2-core, tier2-augmented, simulated) and display in step details and Design Brief

## Rollout Phases
- Phase 1: Simulated endâ€‘toâ€‘end demos on /site/forge with Design Brief and artifact export
- Phase 2: Hybrid runs â€” enable selected validator steps to hit live adapters while others stay simulated
- Phase 3: Add regulatory/epigenome generators, deeper offâ€‘target analysis, and enriched orchestrator summaries
